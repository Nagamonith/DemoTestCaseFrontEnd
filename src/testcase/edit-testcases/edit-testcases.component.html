<app-alert
  [type]="alertType"
  [message]="alertMessage"
  [show]="showAlert"
  [isConfirm]="isConfirmAlert"
  (onConfirm)="handleConfirmDelete()"
  (onCancel)="handleCancelDelete()">
</app-alert>

<div class="container">
  <h2 class="text-center">Test Case Management</h2>
  <!-- <button (click)="printData()">Print Debug Data</button> -->

  <!-- Debug information -->
  <!-- <div class="debug-info" *ngIf="selectedModule()">
    <div><strong>Debug Info:</strong></div>
    <div>Module ID: {{ selectedModule() }}</div>
    <div>Module Name: {{ getModuleName(selectedModule()) }}</div>
    <div>Versions: {{ versions() | json }}</div>
    <div>Total Test Cases: {{ testCases().length }}</div>
    <div>Filtered Test Cases: {{ filteredTestCases().length }}</div>
  </div> -->

  <!-- Module and Version display -->
  <div class="module-info">
    <div><strong>Module:</strong> {{ getModuleName(selectedModule()) }}</div>
    <button class="btn-small-back" (click)="goBack()">üîô Change Module</button>
  </div>

  <!-- Filters -->
  <div class="filters-container">
    <label>Search Filters</label>
    <div class="filters">
      <div class="filter-group">
        <label>Sl No:</label>
        <input
          type="text"
          placeholder="Filter by Sl No"
          [ngModel]="filter().slNo"
          (ngModelChange)="updateFilter('slNo', $event)"
        />
      </div>
      
      <div class="filter-group">
        <label>Test Case ID:</label>
        <input
          type="text"
          placeholder="Filter by TestCase ID"
          [ngModel]="filter().testCaseId"
          (ngModelChange)="updateFilter('testCaseId', $event)"
        />
      </div>
      
      <div class="filter-group">
        <label>Use Case:</label>
        <input
          type="text"
          placeholder="Filter by Use Case"
          [ngModel]="filter().useCase"
          (ngModelChange)="updateFilter('useCase', $event)"
        />
      </div>
      
      <div class="filter-group">
        <label>Version:</label>
        <select
          [ngModel]="filter().version"
          (ngModelChange)="updateFilter('version', $event)"
        >
          <option value="">All Versions</option>
          <option *ngFor="let version of versions()" [value]="version">
            {{ version }}
          </option>
        </select>
      </div>
    </div>
  </div>
<!-- Test case table -->
<div *ngIf="filteredTestCases().length > 0" class="table-container">
  <table class="test-case-table">
    <thead>
      <tr>
        <th>Sl.No</th>
        <th>Version</th>
        <th>Test Case ID</th>
        <th>Use Case</th>
        <th>Scenario</th>
        <th>Steps</th>
        <th>Expected</th>
        
        <!-- Dynamic attribute columns -->
        <th *ngFor="let attrName of getUniqueAttributeNames()">
          {{attrName}}
        </th>
        
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let testCase of filteredTestCases()">
        <td>{{testCase.slNo}}</td>
        <td>{{testCase.version}}</td>
        <td>{{testCase.testCaseId}}</td>
        <td class="wrap-text">{{testCase.useCase}}</td>
        <td class="wrap-text">{{testCase.scenario}}</td>
        <td class="wrap-text">{{testCase.steps}}</td>
        <td class="wrap-text">{{testCase.expected}}</td>
        
        <!-- Dynamic attribute values -->
        <td *ngFor="let attrName of getUniqueAttributeNames()" class="wrap-text">
          {{getAttributeValue(testCase, attrName) || '-'}}
        </td>
        
        <td class="actions">
          <button class="btn-small" (click)="startEditing(testCase)">Edit</button>
          <button class="btn-small-danger" (click)="deleteTestCase(testCase.id, $event)">Delete</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

  <!-- No results message -->
  <div *ngIf="filteredTestCases().length === 0" class="no-results">
    <div *ngIf="testCases().length === 0" class="no-data">
      ‚ö†Ô∏è No test cases found for this module.
      <button (click)="loadTestCases(selectedModule())" class="btn-refresh">Refresh</button>
    </div>
    <div *ngIf="testCases().length > 0 && filteredTestCases().length === 0" class="no-matches">
      No test cases match your filters. Try adjusting your search criteria.
    </div>
  </div>

  <button class="btn-save" (click)="openForm()">Add New Test Case</button>

  <!-- Add/Edit Test Case Form -->
  <div *ngIf="isEditing()" class="form-overlay">
    <form [formGroup]="form" (ngSubmit)="saveTestCase()" class="test-case-form">
      <h3>{{ form.value.id ? 'Edit' : 'Add' }} Test Case</h3>

   <div class="form-group">
  <label>Version:</label>
  <select formControlName="version">
    <option *ngFor="let version of versions()" [value]="version">
      {{ version }} 
    </option>
  </select>
  <div *ngIf="form.get('version')?.invalid && form.get('version')?.touched" class="error-message">
    Version is required
  </div>
</div>

      <div class="form-group">
        <label>Test Case ID:</label>
        <input type="text" formControlName="testCaseId" />
        <div *ngIf="form.get('testCaseId')?.invalid && form.get('testCaseId')?.touched" class="error-message">
          Test Case ID is required and must start with TC
        </div>
      </div>

      <div class="form-group">
        <label>Use Case:</label>
        <input type="text" formControlName="useCase" />
        <div *ngIf="form.get('useCase')?.invalid && form.get('useCase')?.touched" class="error-message">
          Use Case is required
        </div>
      </div>

      <div class="form-group">
        <label>Scenario:</label>
        <textarea formControlName="scenario" rows="3"></textarea>
        <div *ngIf="form.get('scenario')?.invalid && form.get('scenario')?.touched" class="error-message">
          Scenario is required
        </div>
      </div>

      <div class="form-group">
        <label>Steps:</label>
        <textarea formControlName="steps" rows="5"></textarea>
        <div *ngIf="form.get('steps')?.invalid && form.get('steps')?.touched" class="error-message">
          Steps are required
        </div>
      </div>

      <div class="form-group">
        <label>Expected Result:</label>
        <textarea formControlName="expected" rows="3"></textarea>
        <div *ngIf="form.get('expected')?.invalid && form.get('expected')?.touched" class="error-message">
          Expected result is required
        </div>
      </div>

      <div class="form-group">
        <label>Result:</label>
        <select formControlName="result">
          <option value="Pending">Pending</option>
          <option value="Pass">Pass</option>
          <option value="Fail">Fail</option>
          <option value="Blocked">Blocked</option>
        </select>
      </div>

      <div class="form-group" *ngIf="form.value.result === 'Fail' || form.value.result === 'Blocked'">
        <label>Actual Result:</label>
        <textarea formControlName="actual" rows="2"></textarea>
      </div>

      <div class="form-group" *ngIf="form.value.result === 'Fail' || form.value.result === 'Blocked'">
        <label>Remarks:</label>
        <textarea formControlName="remarks" rows="2"></textarea>
      </div>

      <!-- Dynamic Attributes -->
      <div class="attributes-section">
        <h4>Attributes</h4>
        <div formArrayName="attributes">
          <div *ngFor="let attr of attributes.controls; let i = index" [formGroupName]="i" class="attribute-item">
            <input formControlName="key" placeholder="Attribute name" />
            <textarea formControlName="value" placeholder="Value"></textarea>
            <button type="button" class="btn-small-danger" (click)="removeAttribute(i)">
              Remove
            </button>
          </div>
        </div>
        <button type="button" class="btn-small" (click)="addAttribute()">Add Attribute</button>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-save" [disabled]="form.invalid">Save</button>
        <button type="button" class="btn-small-danger" (click)="cancelEditing()">Cancel</button>
      </div>
    </form>
  </div>
</div>